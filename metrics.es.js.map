{"version":3,"file":"metrics.es.js","sources":["src/lib/storage.js","src/lib/capabilities.js","src/lib/utils.js","src/lib/reporter.js","src/lib/metrics.js"],"sourcesContent":["class LS {\n  constructor (win = window, prefix = '') {\n    try {\n      this.storage = win.localStorage;\n    } catch (err) {\n      this.storage = {};\n    }\n    this.prefix = prefix || '';\n  }\n\n  get (key) {\n    try {\n      return this.storage[this.prefix + key];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  set (key, value) {\n    try {\n      this.storage[this.prefix + key] = value;\n      return value;\n    } catch (err) {\n      return null;\n    }\n  }\n\n  remove (key) {\n    if (Array.isArray(key)) {\n      return key.map(name => this.remove(name));\n    }\n    try {\n      delete this.storage[this.prefix + key];\n    } catch (err) {\n      return null;\n    }\n  }\n\n  delete (key) {\n    return this.remove(key);\n  }\n\n  clear (key) {\n    try {\n      delete this.storage;\n    } catch (err) {\n      return null;\n    }\n    this.storage = {};\n  }\n}\n\nexport default LS;\n","export default class Capabilities {\n  constructor (win = window, doc = document, nav = navigator) {\n    this.win = win;\n    this.doc = doc;\n    this.nav = nav || this.win.navigator || navigator || {};\n  }\n\n  get browserFeatures () {\n    if (this._browserFeatures) {\n      return this._browserFeatures;\n    }\n    this._browserFeatures = new BrowserFeatures(this.win, this.doc, this.nav);\n  }\n\n  get browserSettings () {\n    if (this._browserSettings) {\n      return this._browserSettings;\n    }\n    this._browserSettings = new BrowserSettings(this.win, this.doc, this.nav);\n  }\n\n  get hardwareFeatures () {\n    if (this._hardwareFeatures) {\n      return this._hardwareFeatures;\n    }\n    this._hardwareFeatures = new HardwareFeatures(this.win, this.doc, this.nav);\n  }\n}\n\nclass BrowserFeatures {\n  constructor (win = window, doc = document, nav = navigator) {\n    this.win = win;\n    this.doc = doc;\n    this.nav = nav || this.win.navigator || navigator || {};\n  }\n\n  get userAgent () {\n    return this.nav.userAgent;\n  }\n\n  get gamepads () {\n    return !!this.nav.getGamepads;\n  }\n\n  get webaudio () {\n    return !!this.win.AudioContext || !!this.win.webkitAudioContext;\n  }\n\n  get wasm () {\n    return !!this.win.WebAssembly;\n  }\n\n  get requestIdleCallback () {\n    return !!this.win.requestIdleCallback;\n  }\n\n  get webgl () {\n    try {\n      const canvas = this.doc.createElement('canvas');\n      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');\n      if (gl && gl instanceof this.win.WebGLRenderingContext) {\n        return true;\n      }\n    } catch (err) {\n    }\n    return false;\n  }\n\n  get webgl2 () {\n    try {\n      const canvas = this.doc.createElement('canvas');\n      const gl = canvas.getContext('webgl2');\n      if (gl && gl instanceof this.win.WebGL2RenderingContext) {\n        return true;\n      }\n    } catch (err) {\n    }\n    return false;\n  }\n\n  get webrtc () {\n    return !!this.win.RTCPeerConnection && !!this.win.RTCDataChannelEvent;\n  }\n\n  get websocket () {\n    return !!this.win.WebSocket;\n  }\n\n  get webworker () {\n    return !!this.win.Worker;\n  }\n\n  get serviceworker () {\n    return !!this.nav.serviceWorker;\n  }\n\n  get webvr () {\n    return !!this.nav.getVRDisplays;\n  }\n\n  get webxr () {\n    return !!this.nav.xr;\n  }\n}\n\nclass BrowserSettings {\n  constructor (win = window, doc = document, nav = navigator) {\n    this.win = win;\n    this.doc = doc;\n    this.nav = nav || this.win.navigator || navigator || {};\n  }\n\n  get cookieEnabled () {\n    return !!this.nav.cookieEnabled || false;\n  }\n\n  get doNotTrackEnabled () {\n    // If enabled in your browser, typically it'll be\n    // `navigator.doNotTrack === '1'`.\n    // (Yes, a string.)\n    const doNotTrack = this.nav.doNotTrack || false;\n    if (!!doNotTrack || doNotTrack === 'unspecified') {\n      return false;\n    }\n    return true;\n  }\n}\n\nclass HardwareFeatures {\n  constructor (win = window, doc = document, nav = navigator) {\n    this.win = win;\n    this.doc = doc;\n    this.nav = nav || this.win.navigator || navigator || {};\n  }\n\n  get devicePixelRatio () {\n    return this.win.devicePixelRatio || 1;\n  }\n\n  get endianness () {\n    if (!this.win.ArrayBuffer) {\n      return 'Unknown';\n    }\n    const buffer = new this.win.ArrayBuffer(4);\n    const intView = new this.win.Uint32Array(buffer);\n    const byteView = new this.win.Uint8Array(buffer);\n    intView[0] = 1;\n    return byteView[0] === 1 ? 'little' : 'big';\n  }\n\n  get screenResolution () {\n    return `${this.win.screen.width}x${this.win.screen.height}`;\n  }\n\n  get workerPoolSize () {\n    return this.nav.hardwareConcurrency || 0;\n  }\n\n  get windowSize () {\n    return `${this.win.innerWidth}x${this.win.innerHeight}`;\n  }\n}\n","/* global XMLHttpRequest */\nconst postBeacon = (url, data = null, nav) => {\n  nav = nav || win.navigator;\n  if ('sendBeacon' in nav) {\n    return nav.sendBeacon(url, data);\n  }\n  let xhr = new XMLHttpRequest();\n  xhr.open('POST', url);\n  return xhr.send(data);\n};\n\nlet querystring = {};\nfunction strictUriEncode (str) {\n  return encodeURIComponent(str).replace(/[!'()*]/g, x => `%${x.charCodeAt(0).toString(16).toUpperCase()}`);\n}\nfunction encode (value, opts) {\n  if (opts.encode) {\n    return opts.strict ? strictUriEncode(value) : encodeURIComponent(value);\n  }\n  return value;\n}\nquerystring.stringify = (obj, opts) => {\n  if (!obj) {\n    return '';\n  }\n  const defaults = {\n    encode: true,\n    strict: true\n  };\n  opts = Object.assign({}, obj, defaults);\n  if (opts.sort === false) {\n    opts.sort = () => {};\n  }\n  const arrayFormatter = (key, value) => value === null ? encode(key, opts) : [\n    encode(key, opts),\n    '=',\n    encode(value, opts)\n  ].join('');\n  return Object.keys(obj).sort(opts.sort).map(key => {\n    const val = obj[key];\n    if (val === undefined) {\n      return '';\n    }\n    if (val === null) {\n      return encode(key, opts);\n    }\n    if (Array.isArray(val)) {\n      const result = [];\n      val.slice().forEach(val2 => {\n        if (val2 === undefined) {\n          return;\n        }\n        result.push(arrayFormatter(key, val2, result.length));\n      });\n      return result.join('&');\n    }\n    return `${encode(key, opts)}=${encode(val, opts)}`;\n  }).filter(x => {\n    return x.length > 0;\n  }).join('&');\n};\n\nexport default {\n  querystring,\n  postBeacon,\n};\n","import Capabilities from './capabilities.js';\nimport LS from './storage.js';\n\nimport utils from './utils.js';\n\nlet ua = {\n  config: {\n    protocolVersion: '1',\n    dataSource: 'web'\n  }\n};\n\nconst inDevMode = (win) => {\n  return win.isSecureContext === false || (win.location.protocol === 'http:' && win.location.port);\n};\n\nconst defaultOptions = {\n  trackingId: '',\n  baseTelemetryCollectionUrl: 'https://ssl.google-analytics.com/collect?'\n};\n\nclass Reporter {\n  constructor (opts, storage, win = window, doc = document, nav = navigator) {\n    if (typeof opts === 'string') {\n      this.opts = {trackingId: opts};\n    } else {\n      this.opts = Object.assign({}, this.opts, defaultOptions);\n    }\n    this.trackingId = this.opts.trackingId;\n    if (!this.trackingId) {\n      throw new Error('`trackingId` argument required for `Reporter` (e.g., `UA-XXXXXXXXX-Y`)');\n    }\n    this.baseTelemetryCollectionUrl = this.opts.baseTelemetryCollectionUrl;\n    this.win = win || window;\n    this.doc = doc || document;\n    this.nav = nav || this.win.navigator || navigator || {};\n    this.storage = storage || new LS(this.win, 'xrAgent.metrics.');\n    this.consented = this.hasConsented();\n  }\n\n  setTrackingId (trackingId = null) {\n    this.trackingId = trackingId;\n  }\n\n  saveConsent (consented = true) {\n    if (this.hasConsented()) {\n      return false;\n    }\n    this.storage.set('settings.consent', consented ? 'true' : 'false');\n    return true;\n  }\n\n  removeConsent (consented = true) {\n    if (!this.hasConsented()) {\n      return false;\n    }\n    this.storage.remove([\n      'clientId',\n      'name',\n      'version',\n      'settings.consent'\n    ]);\n    return true;\n  }\n\n  hasConsented () {\n    if (this.consented === true) {\n      return true;\n    }\n    return this.storage.get('settings.consent') !== 'false';\n  }\n\n  sendPageView (path, hostname, title, extraParams) {\n    const params = {\n      t: 'pageview',\n      path,\n      hostname,\n      title,\n      params: extraParams\n    };\n    return this.send(params);\n  }\n\n  sendEvent (category, action, label, value) {\n    const params = {\n      t: 'event',\n      ec: category,\n      ea: action\n    };\n    if (label !== null) {\n      params.el = label;\n    }\n    if (value !== null) {\n      params.ev = value;\n    }\n    return this.send(params);\n  }\n\n  sendTiming (category, name, value) {\n    const params = {\n      t: 'timing',\n      utc: category,\n      utv: name,\n      utt: value\n    };\n    return this.send(params);\n  }\n\n  sendException (description) {\n    const params = {\n      t: 'exception',\n      exd: description,\n      exf: inDevMode(this.win) ? '0' : '1'\n    };\n    return this.send(params);\n  }\n\n  sendCommand (commandName) {\n    if (this.commandCount === null) {\n      this.commandCount = {};\n    }\n    let base = this.commandCount;\n    if (base[commandName] === null) {\n      base[commandName] = 0;\n    }\n    this.commandCount[commandName]++;\n    const params = {\n      t: 'event',\n      ec: 'command',\n      ea: commandName.split(':')[0],\n      el: commandName,\n      ev: this.commandCount[commandName]\n    };\n    return this.send(params);\n  }\n\n  send (params) {\n    if (!this.hasConsented()) {\n      return;\n    }\n\n    this.trackingId = params.trackingId || this.trackingId || this.storage.get('trackingId');\n    this.clientId = this.clientId || this.storage.get('clientId');\n\n    this.documentPath = params.documentPath || params.uri || this.uri;\n    this.p = params.p || this.p || this.documentPath;\n\n    this.dh = params.host || params.dh || this.host;\n    this.dt = params.title || params.dt || this.title;\n    this.dr = params.referrer || params.dr || this.dr;\n    this.uip = params.remoteAddr || params.uip || this.uip;\n\n    this.xrAgentName = this.xrAgentName || this.storage.get('name');\n    this.xrAgentVersion = this.xrAgentVersion || this.storage.get('version');\n\n    if (!navigator.onLine) {\n      return;\n    }\n\n    // Reference: https://github.com/peaksandpies/universal-analytics/blob/master/AcceptableParams.md\n    params = Object.assign({}, params, {\n      v: ua.config.protocolVersion,  // Protocol version.\n      aip: 1,  // Anonymize IP.\n      tid: this.trackingId,  // Tracking ID.\n      ds: ua.config.dataSource,  // Data source.\n      cid: this.clientId,  // Client ID.\n      dp: this.uri,\n      dh: this.dh,\n      dt: this.dt,\n      dr: this.dr,\n      p: this.p,\n      uip: this.remoteAddr,\n      an: this.xrAgentName,  // App Name.\n      av: this.xrAgentVersion  // App Version.\n    });\n    params = Object.assign({}, params, this.consentedParams());\n    if (this.isTelemetryConsentChoice(params)) {\n      return this.request(`${this.baseTelemetryCollectionUrl}${utils.querystring.stringify(params)}`);\n    }\n  }\n\n  isTelemetryConsentChoice (params) {\n    return params.t === 'event' && params.ec === 'setting' && params.ea === 'settings.consent';\n  }\n\n  request (url) {\n    console.log('request', url);\n    return utils.postBeacon(url);\n  }\n\n  consentedParams () {\n    const capabilities = new Capabilities(this.win, this.doc, this.nav);\n    const hardware = capabilities.hardwareFeatures;\n    const browser = capabilities.browserFeatures;\n    console.log(capabilities, hardware);\n    return {\n      sr: hardware.screenResolution,\n      vp: hardware.windowSize,\n      dpr: hardware.devicePixelRatio,\n      capvr: browser.webvr,\n      capxr: browser.webxr,\n      capgp: browser.gamepads,\n      capaudio: browser.webaudio,\n      capwasm: browser.wasm,\n      capric: browser.requestIdleCallback,\n      capwebgl: browser.webgl,\n      capwebgl2: browser.webgl2,\n      capworker: browser.worker,\n      capsw: browser.serviceworker,\n      caphc: hardware.workerPoolSize,\n      capws: browser.websocket,\n      capwebrtc: browser.webrtc,\n      capendian: hardware.endianness,\n      ua: browser.userAgent\n    };\n  }\n}\n\nexport default Reporter;\n","import LS from './storage.js';\nimport Reporter from './reporter.js';\n\nconst PathRE = /'?((\\/|\\\\|[a-z]:\\\\)[^\\s']+)+'?/ig;\nconst stripPath = msg => msg.replace(PathRE, '<path>');\n\n/**\n * Generates a random UUID (version 4), compliant with RFC4122 (https://www.ietf.org/rfc/rfc4122.txt).\n *\n * Source adapted from https://gist.github.com/jcxplorer/823878\n */\nfunction uuidV4 () {\n  let uuid = '';\n  let idx;\n  let random;\n  for (idx = 0; idx < 32; idx++) {\n    random = Math.random() * 16 | 0;\n    if (idx === 8 || idx === 12 || idx === 16 || idx === 20) {\n      uuid += '-';\n    }\n    uuid += (idx === 12 ? 4 : (idx === 16 ? (random & 3 | 8) : random)).toString(16);\n  }\n  return uuid;\n}\n\nclass Metrics {\n  constructor (trackingId, clientId, storage, reporter, win = window, doc = document) {\n    this.clientId = clientId;\n    this.win = win || window;\n    this.doc = doc || document;\n    this.storage = storage || new LS(this.win, 'xrAgent.metrics.');\n    this.reporter = reporter || new Reporter(this.trackingId, this.storage, this.win, this.doc);\n    this.trackingId = trackingId || reporter.trackingId;\n  }\n\n  activate (arg = {}) {\n    if (!this.reporter.hasConsented()) {\n      return false;\n    }\n    this.subscriptions = [];\n    let sessionLength = arg.sessionLength || Date.now();\n    return this.ensureClientId(((_this => () => _this.begin(sessionLength)))(this));\n  }\n\n  deactivate () {\n    delete this.subscriptions;\n    this.subscriptions = [];\n  }\n\n  serialize () {\n    return {\n      sessionLength: Date.now() - this.sessionStart\n    };\n  }\n\n  provideReporter () {\n    return {\n      sendEvent: this.reporter.sendEvent.bind(this.reporter),\n      sendTiming: this.reporter.sendTiming.bind(this.reporter),\n      sendException: this.reporter.sendException.bind(this.reporter)\n    };\n  }\n\n  begin (sessionLength) {\n    this.sessionStart = Date.now();\n    if (sessionLength) {\n      this.reporter.sendEvent('window', 'ended', null, sessionLength);\n    }\n    this.reporter.sendEvent('window', 'started');\n    this.watchExceptions();\n    this.watchPageView();\n  }\n\n  ensureClientId (callback) {\n    if (this.storage.get('clientId')) {\n      return callback();\n    }\n    return this.createClientId(clientId => {\n      this.storage.set('clientId', clientId);\n      return callback();\n    });\n  }\n\n  createClientId (callback) {\n    if (this.clientId) {\n      return callback(this.clientId);\n    }\n    return callback(uuidV4);\n  }\n\n  getClientId () {\n    return this.storage.get('clientId');\n  }\n\n  getTid () {\n    if (this.trackingId) {\n      return this.trackingId;\n    }\n    this.trackingId = this.storage.get('tid');\n    return this.trackingId;\n  }\n\n  setTid (trackingId) {\n    this.trackingId = this.storage.set('tid', trackingId);\n    return trackingId;\n  }\n\n  watchExceptions () {\n    return this.subscriptions.push(() => {\n      window.addEventListener('error', evt => {\n        let errMsg = evt;\n        if (typeof evt !== 'string') {\n          errMsg = evt.message;\n        }\n        errMsg = (stripPath(errMsg) || 'Unknown').replace('Uncaught ', '').slice(0, 150);\n        return this.reporter.sendException(errMsg);\n      });\n    });\n  }\n\n  watchPageView () {\n    return this.subscriptions.push(() => {\n      this.reporter.sendPageView(self.win.location.pathname, self.win.location.href, self.doc.title);\n    });\n  }\n}\n\nfunction getTrackingId (scriptUrl, win, doc) {\n  win = win || window;\n  doc = doc || document;\n  scriptUrl = scriptUrl || doc.scriptURL || (doc.currentScript && doc.currentScript.src);\n  if (!scriptUrl && doc.currentScript) {\n    const tid = doc.currentScript.getAttribute('data-tid') || doc.currentScript.getAttribute('data-id') || '';\n    if (tid.trim().startsWith('UA-')) {\n      return tid;\n    }\n  }\n  if (!scriptUrl) {\n    return null;\n  }\n  try {\n    const qs = new win.URLSearchParams(new win.URL(scriptUrl).search);\n    return qs.get('tid') || qs.get('id');\n  } catch (err) {\n    return (scriptUrl.match(/[?&]tid=(.+)/i) || [])[1] || (scriptUrl.match(/[?&]id=(.+)/i) || [])[1];\n  }\n}\n\nconst trackingId = getTrackingId();\nconst reporter = new Reporter(trackingId);\nconst metrics = new Metrics(null, null, null, reporter);\nmetrics.activate();\n\nexport default metrics;\n"],"names":["LS","win","prefix","window","storage","localStorage","err","get","key","this","set","value","remove","Array","isArray","map","name","delete","clear","Capabilities","doc","nav","document","navigator","browserFeatures","_browserFeatures","BrowserFeatures","browserSettings","_browserSettings","BrowserSettings","hardwareFeatures","_hardwareFeatures","HardwareFeatures","userAgent","gamepads","getGamepads","webaudio","AudioContext","webkitAudioContext","wasm","WebAssembly","requestIdleCallback","webgl","canvas","createElement","gl","getContext","WebGLRenderingContext","webgl2","WebGL2RenderingContext","webrtc","RTCPeerConnection","RTCDataChannelEvent","websocket","WebSocket","webworker","Worker","serviceworker","serviceWorker","webvr","getVRDisplays","webxr","xr","cookieEnabled","doNotTrackEnabled","doNotTrack","devicePixelRatio","endianness","ArrayBuffer","buffer","intView","Uint32Array","byteView","Uint8Array","screenResolution","screen","workerPoolSize","hardwareConcurrency","windowSize","const","querystring","encode","opts","strict","encodeURIComponent","replace","x","charCodeAt","toString","toUpperCase","stringify","obj","Object","assign","sort","keys","val","undefined","result","slice","forEach","val2","push","join","arrayFormatter","filter","length","url","data","sendBeacon","let","xhr","XMLHttpRequest","open","send","ua","protocolVersion","dataSource","defaultOptions","trackingId","baseTelemetryCollectionUrl","Reporter","Error","consented","hasConsented","setTrackingId","saveConsent","removeConsent","sendPageView","path","hostname","title","extraParams","sendEvent","category","action","label","params","el","ev","sendTiming","sendException","description","isSecureContext","location","protocol","port","sendCommand","commandName","commandCount","base","split","clientId","documentPath","uri","p","dh","host","dt","dr","referrer","uip","remoteAddr","xrAgentName","xrAgentVersion","onLine","consentedParams","isTelemetryConsentChoice","request","utils","t","ec","ea","log","postBeacon","capabilities","hardware","browser","worker","PathRE","uuidV4","idx","random","uuid","Math","Metrics","reporter","activate","arg","subscriptions","_this","sessionLength","Date","now","ensureClientId","begin","deactivate","serialize","sessionStart","provideReporter","bind","watchExceptions","watchPageView","callback","createClientId","getClientId","getTid","setTid","addEventListener","evt","msg","errMsg","message","self","pathname","href","scriptUrl","scriptURL","currentScript","src","tid","getAttribute","trim","startsWith","qs","URLSearchParams","URL","search","match","getTrackingId","metrics"],"mappings":"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"}